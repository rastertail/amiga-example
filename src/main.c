#include <proto/exec.h>
#include <proto/dos.h>
#include <proto/graphics.h>
#include <graphics/gfxbase.h>
#include <hardware/custom.h>
#include <hardware/dmabits.h>

// Registers
volatile struct Custom* custom;

// Libraries
struct ExecBase* SysBase;
struct GfxBase* GfxBase;
struct DosLibrary* DOSBase;

// OS State
static UWORD SystemInts;
static UWORD SystemDMA;
static UWORD SystemADKCON;
static volatile APTR VBR = 0;
static APTR SystemIRQ;
struct View* ActiView;

static UWORD copperlist[] __attribute__((section(".chip"))) = {
    __builtin_offsetof(struct Custom, color[0]), 0x000,

    // rasterbar
    0x4101, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x222,
    0x4201, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x444,
    0x4301, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x666,
    0x4401, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x888,
    0x4501, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0xaaa,
    0x4601, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0xccc,
    0x4701, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0xeee,
    0x4801, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0xccc,
    0x4901, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0xaaa,
    0x4a01, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x888,
    0x4b01, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x666,
    0x4c01, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x444,
    0x4d01, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x222,
    0x4e01, 0xff00,
    __builtin_offsetof(struct Custom, color[0]), 0x000,

    //end
    0xfff, 0xfffe,
};

const UBYTE sintab[] = {
    0x20,0x21,0x22,0x22,0x23,0x24,0x25,0x25,
    0x26,0x27,0x28,0x29,0x29,0x2a,0x2b,0x2c,
    0x2c,0x2d,0x2e,0x2e,0x2f,0x30,0x30,0x31,
    0x32,0x32,0x33,0x34,0x34,0x35,0x35,0x36,
    0x37,0x37,0x38,0x38,0x39,0x39,0x3a,0x3a,
    0x3b,0x3b,0x3b,0x3c,0x3c,0x3d,0x3d,0x3d,
    0x3e,0x3e,0x3e,0x3e,0x3f,0x3f,0x3f,0x3f,
    0x3f,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
    0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,
    0x3f,0x3f,0x3f,0x3f,0x3f,0x3e,0x3e,0x3e,
    0x3e,0x3d,0x3d,0x3d,0x3c,0x3c,0x3b,0x3b,
    0x3b,0x3a,0x3a,0x39,0x39,0x38,0x38,0x37,
    0x37,0x36,0x35,0x35,0x34,0x34,0x33,0x32,
    0x32,0x31,0x30,0x30,0x2f,0x2e,0x2e,0x2d,
    0x2c,0x2c,0x2b,0x2a,0x29,0x29,0x28,0x27,
    0x26,0x25,0x25,0x24,0x23,0x22,0x22,0x21,
    0x20,0x1f,0x1e,0x1e,0x1d,0x1c,0x1b,0x1b,
    0x1a,0x19,0x18,0x17,0x17,0x16,0x15,0x14,
    0x14,0x13,0x12,0x12,0x11,0x10,0x10,0xf,
    0xe,0xe,0xd,0xc,0xc,0xb,0xb,0xa,
    0x9,0x9,0x8,0x8,0x7,0x7,0x6,0x6,
    0x5,0x5,0x5,0x4,0x4,0x3,0x3,0x3,
    0x2,0x2,0x2,0x2,0x1,0x1,0x1,0x1,
    0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
    0x1,0x1,0x1,0x1,0x1,0x2,0x2,0x2,
    0x2,0x3,0x3,0x3,0x4,0x4,0x5,0x5,
    0x5,0x6,0x6,0x7,0x7,0x8,0x8,0x9,
    0x9,0xa,0xb,0xb,0xc,0xc,0xd,0xe,
    0xe,0xf,0x10,0x10,0x11,0x12,0x12,0x13,
    0x14,0x14,0x15,0x16,0x17,0x17,0x18,0x19,
    0x1a,0x1b,0x1b,0x1c,0x1d,0x1e,0x1e,0x1f,
};

void wait_vbl() {
    while ((*(volatile ULONG*)0xdff004 & 0x1ff00) != (312 << 8)) {}
}

int main() {
    /* INIT */

    // Load pointers to custom registers and ExecBase
    custom = (struct Custom*)0xdff000;
    SysBase = *((struct ExecBase**)4UL);

    // Load libraries
    DOSBase = (struct DosLibrary*)OpenLibrary((CONST_STRPTR)"dos.library", 0);
    if (!DOSBase) return 1;

    GfxBase = (struct GfxBase*)OpenLibrary((CONST_STRPTR)"graphics.library", 0);
    if (!GfxBase) {
        CloseLibrary((struct Library*)DOSBase);
        return 1;
    }

    // Start taking control of the system
    OwnBlitter();
    WaitBlit();
    Disable();

    // TODO Read VBR on >=68010... assuming it is 0 for now
    
    // Save OS state
    ActiView = GfxBase->ActiView;
    SystemADKCON = custom->adkconr;
    SystemInts = custom->intenar;
    SystemDMA = custom->dmaconr;
    SystemIRQ = *(volatile APTR*)(((UBYTE*)VBR)+0x6c);

    // Disable and clear pending interrupts
    custom->intena = 0x7fff;
    custom->intreq = 0x7fff;

    // Disable all DMA channels
    wait_vbl();
    custom->dmacon = 0x7fff;

    // Switch to a blank screen
    LoadView(NULL);

    // Wait for both copper lists to finish
    WaitTOF();
    WaitTOF();

    // Wait for vblank once more
    wait_vbl();

    /* MAIN */

    // Enable copper DMA
    custom->dmacon = DMAF_SETCLR | DMAF_MASTER | DMAF_COPPER;

    // Write new copper list
    custom->cop1lc = (ULONG)copperlist;
    custom->copjmp1 = 0x7fff;

    UBYTE t = 0;

    // Wait for the mouse to be clicked
    volatile UBYTE* ciaa_pra = (volatile UBYTE*)0xbfe001;
    while ((*ciaa_pra & (1 << 6)) != 0) {
        // TODO move into copper irq
        wait_vbl();
        for (UBYTE i = 0; i < 14; i++) {
            copperlist[2 + i * 4] = 0x4001 + (i + sintab[t]) * 0x100;
        }

        t++;
    }

    /* CLEANUP */

    // Reset interrupts and DMA again
    custom->intena = 0x7fff;
    custom->intreq = 0x7fff;
    wait_vbl();
    custom->dmacon = 0x7fff;

    // Restore interrupt vector
    *(volatile APTR*)(((UBYTE*)VBR)+0x6c) = SystemIRQ;

    // Restore system copper lists
    custom->cop1lc = (ULONG)GfxBase->copinit;
    custom->cop2lc = (ULONG)GfxBase->LOFlist;
    custom->copjmp1 = 0x7fff;

    // Restore innterrupts and DMA
    custom->intena = SystemInts | 0x8000;
    custom->dmacon = SystemDMA | 0x8000;
    custom->adkcon = SystemADKCON | 0x8000;

    // Finish releasing system
    LoadView(ActiView);
    WaitTOF();
    WaitTOF();
    WaitBlit();
    DisownBlitter();
    Enable();

    // Print a goodbye message
    Write(Output(), "Goodbye!\n", 9);
    
    // Clean up
    CloseLibrary((struct Library*)GfxBase);
    CloseLibrary((struct Library*)DOSBase);

    return 0;
}
